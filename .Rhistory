loci2 = as.numeric(geno_table[, "Chr4:5383224"]),
loci3 = as.numeric(geno_table[, "Chr5:14295930"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
knitr::opts_chunk$set(echo = TRUE)
#install.packages("pkgbuild")
#pkgbuild::check_build_tools(debug = TRUE)
#install.packages(c("Rcpp", "RcppEigen", "cli", "rlang", "vctrs", "pillar", "lifecycle"))
#install.packages(c("devtools","remotes"))
#remotes::install_github("bcm-uga/lfmm",
#                        dependencies = TRUE,
#                        build_vignettes = FALSE,
#                        force = TRUE)
#install.packages("RSpectra")
library(lme4)
library(tibble)
library(dplyr)
library(tidyverse)
library(ggthemes)
library(ggrepel)
library(lfmm)
library(RSpectra)
load("pl_lt_t.lmer.RData")
source("manhattan_plot.R")
ranef(pl_lt_t.lmer)$pop
pheno_2022 <- ranef(pl_lt_t.lmer)$pop %>%
as_tibble(rownames = "pop",.name_repair = "unique")%>%
rename(blup_intercept = `(Intercept)...1`,
blup_light = `mean_light_ly_day2`) %>%
mutate(model = "Y2022")
geno_22 <- read.delim("Data/merged_maf_common_UCD2022.tsv", header = TRUE)
Y <- as.matrix(geno_22[,-1])
pc <- prcomp(Y)
plot(pc$sdev[1:20]^2, xlab = 'PC', ylab = "Variance explained")
points(2,pc$sdev[2]^2, type = "h", lwd = 3, col = "blue")
Y <- as.matrix(geno_22[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2022$blup_light), ncol = 1)
rownames(X) <- pheno_2022$pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
## performs association testing using the fitted model:
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
#QQ plot
qqplot(rexp(length(pvalues), rate = log(10)),
-log10(pvalues), xlab = "Expected quantile",
pch = 19, cex = .4)
abline(0,1)
## Manhattan plot
plot(-log10(pvalues),
pch = 19,
cex = .2,
xlab = "SNP", ylab = "-Log P",
col = "grey")
plot_data = tibble(loci = geno_22[,1], p_val = pv$pvalue[,1], calibrated.pvalue = pv$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
light_manhattan = plot_manhattan(plot_data,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association",
highlight_top_n = 20)
print(light_manhattan)
# Save plot
ggsave("light_interaction22.png", light_manhattan, width = 12, height = 6, dpi = 300)
geno_table = Y
colnames(geno_table) = geno_22[, 1]
freq_plot_data = as.data.frame(X) |>
rownames_to_column(var = "Population") |>
mutate(loci1 = as.numeric(geno_table[, "Chr6:20652277"]),
loci2 = as.numeric(geno_table[, "Chr4:5383224"]),
loci3 = as.numeric(geno_table[, "Chr5:14295930"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
freq_plot_data |>
ggplot(aes(x = blup_light, y = frequency, label = Population)) +
geom_point(size = 3) +
geom_smooth(method = "lm", colour = "red") +
geom_text_repel(size = 6) +
facet_wrap(~loci, nrow = 1, scales = "free_y") +
theme_minimal()+
labs(x = "BLUP light", y = "Allele frequency")
View(geno_table)
geno_table = Y
View(Y)
View(geno_table)
colnames(geno_table) = geno_22[, 1]
geno_table = Y
colnames(geno_table) = geno_22[, 1]
freq_plot_data = as.data.frame(X) |>
rownames_to_column(var = "Population") |>
mutate(loci1 = as.numeric(geno_table[, "Chr6:20652277"]),
loci2 = as.numeric(geno_table[, "Chr4:5383224"]),
loci3 = as.numeric(geno_table[, "Chr5:14295930"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
freq_plot_data |>
ggplot(aes(x = blup_light, y = frequency, label = Population)) +
geom_point(size = 3) +
geom_smooth(method = "lm", colour = "red") +
geom_text_repel(size = 6) +
facet_wrap(~loci, nrow = 1, scales = "free_y") +
theme_minimal()+
labs(x = "BLUP light", y = "Allele frequency")
View(freq_plot_data)
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(tibble)
library(dplyr)
library(tidyverse)
library(ggthemes)
library(ggrepel)
library(lfmm)
library(RSpectra)
load("growth_light_time.lmer.RData")
source("manhattan_plot.R")
pheno_2023 <- ranef(growth_light_time.lmer)$parent_pop %>%
as_tibble(rownames = "parent_pop", .name_repair = "unique") %>%
rename(blup_intercept = `(Intercept)...1`,
blup_light = `weekly_avg_SlrW2`) %>%
mutate(model = "Y2023")
geno_23 <- read.delim("Data/merged_maf_common_WL2_2023.tsv", header = TRUE)
Y <- as.matrix(geno_23[,-1])
pc <- prcomp(Y)
plot(pc$sdev[1:20]^2, xlab = 'PC', ylab = "Variance explained")
points(2,pc$sdev[2]^2, type = "h", lwd = 3, col = "blue")
Y <- as.matrix(geno_23[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2023$blup_light), ncol = 1)
rownames(X) <- pheno_2023$parent_pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
#QQ plot
qqplot(rexp(length(pvalues), rate = log(10)),
-log10(pvalues), xlab = "Expected quantile",
pch = 19, cex = .4)
abline(0,1)
plot_data = tibble(loci = geno_23[,1], p_val = pv$pvalue[,1], calibrated.pvalue = pv$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
light_manhattan = plot_manhattan(plot_data,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association",
highlight_top_n = 20)
print(light_manhattan)
# Save plot
ggsave("light_interaction23.png", light_manhattan, width = 12, height = 6, dpi = 300)
geno_table = Y
colnames(geno_table) = geno_23[, 1]
freq_plot_data = as.data.frame(X) |>
rownames_to_column(var = "Population") |>
mutate(loci1 = as.numeric(geno_table[, "Chr6:20652277"]),
loci2 = as.numeric(geno_table[, "Chr4:5383224"]),
loci3 = as.numeric(geno_table[, "Chr5:14295930"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
Y <- as.matrix(geno_22[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2022$blup_light), ncol = 1)
rownames(X) <- pheno_2022$pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
## performs association testing using the fitted model:
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
View(pvalues)
View(Y)
View(Y)
geno_table = Y
colnames(geno_table) = geno_22[, 1]
sig_snps <- names(pvalues)[which(pvalues < 1e-5)]
head(sig_snps)
sig_snps <- names(pvalues)[which(pvalues < 1e-3)]
head(sig_snps)
sig_snps <- names(pvalues)[which(pvalues < 1e-1)]
head(sig_snps)
sig_snps <- names(pvalues)[which(pvalues < 1)]
head(sig_snps)
View(pvalues)
sig_snps <- names(pvalues)[which(blup_light < 1)]
sig_snps <- names(pvalues)[which(pvalues < 1)]
head(sig_snps)
View(Y)
```{r fig.show='hold', out.width='49%'}
print(light_manhattan)
knitr::include_graphics("light_interaction22.png")
library(cowplot)
img2 <- ggdraw() + draw_image("light_interaction22.png")
cowplot::magick
install.packages("magick")
img2 <- ggdraw() + draw_image("light_interaction22.png")
plot_grid(light_manhattan, img2, ncol = 2, rel_widths = c(1, 1))
library(cowplot)
install.packages("magick")
img2 <- ggdraw() + draw_image("light_interaction22.png")
plot_grid(light_manhattan, img2, ncol = 2, rel_widths = c(1, 1))
#library(cowplot)
#install.packages("magick")
img2 <- ggdraw() + draw_image("light_interaction22.png")
plot_grid(light_manhattan, img2, ncol = 2, rel_widths = c(1, 1))
knitr::opts_chunk$set(echo = TRUE)
Y_2023 <- as.matrix(geno_23[,-1])
Y_2023 <- t(Y_2023)
X_2023 <- matrix(scale(pheno_2023$blup_light), ncol = 1)
rownames(X_2023) <- pheno_2023$parent_pop
colnames(X_2023) <- "blup_light"
common <- intersect(rownames(X_2023), rownames(Y_2023))
Y_2023 <- Y_2023[common,]
X_2023 <- X_2023[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y_2023,
X = X_2023,
K = 2)
knitr::opts_chunk$set(echo = TRUE)
#install.packages("pkgbuild")
#pkgbuild::check_build_tools(debug = TRUE)
#install.packages(c("Rcpp", "RcppEigen", "cli", "rlang", "vctrs", "pillar", "lifecycle"))
#install.packages(c("devtools","remotes"))
#remotes::install_github("bcm-uga/lfmm",
#                        dependencies = TRUE,
#                        build_vignettes = FALSE,
#                        force = TRUE)
#install.packages("RSpectra")
library(lme4)
library(tibble)
library(dplyr)
library(tidyverse)
library(ggthemes)
library(ggrepel)
library(lfmm)
library(patchwork)
library(RSpectra)
load("pl_lt_t.lmer.RData")
source("manhattan_plot.R")
ranef(pl_lt_t.lmer)$pop
pheno_2022 <- ranef(pl_lt_t.lmer)$pop %>%
as_tibble(rownames = "pop",.name_repair = "unique")%>%
rename(blup_intercept = `(Intercept)...1`,
blup_light = `mean_light_ly_day2`) %>%
mutate(model = "Y2022")
geno_22 <- read.delim("Data/merged_maf_common_UCD2022.tsv", header = TRUE)
Y <- as.matrix(geno_22[,-1])
pc <- prcomp(Y)
plot(pc$sdev[1:20]^2, xlab = 'PC', ylab = "Variance explained")
points(2,pc$sdev[2]^2, type = "h", lwd = 3, col = "blue")
Y <- as.matrix(geno_22[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2022$blup_light), ncol = 1)
rownames(X) <- pheno_2022$pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
## performs association testing using the fitted model:
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
#QQ plot
qqplot(rexp(length(pvalues), rate = log(10)),
-log10(pvalues), xlab = "Expected quantile",
pch = 19, cex = .4)
abline(0,1)
## Manhattan plot
plot(-log10(pvalues),
pch = 19,
cex = .2,
xlab = "SNP", ylab = "-Log P",
col = "grey")
plot_data = tibble(loci = geno_22[,1], p_val = pv$pvalue[,1], calibrated.pvalue = pv$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
light_manhattan_UCD = plot_manhattan(plot_data,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association UCD 2022",
highlight_top_n = 20)
print(light_manhattan_UCD)
# Save plot
ggsave("light_interaction_UCD.png", light_manhattan_UCD, width = 12, height = 6, dpi = 300)
geno_table = Y
colnames(geno_table) = geno_22[, 1]
freq_plot_data = as.data.frame(X) |>
rownames_to_column(var = "Population") |>
mutate(loci1 = as.numeric(geno_table[, "Chr6:20652277"]),
loci2 = as.numeric(geno_table[, "Chr4:5383224"]),
loci3 = as.numeric(geno_table[, "Chr5:14295930"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
freq_plot_data |>
ggplot(aes(x = blup_light, y = frequency, label = Population)) +
geom_point(size = 3) +
geom_smooth(method = "lm", colour = "red") +
geom_text_repel(size = 6) +
facet_wrap(~loci, nrow = 1, scales = "free_y") +
theme_minimal()+
labs(x = "BLUP light", y = "Allele frequency")
Y_2023 <- as.matrix(geno_23[,-1])
Y_2023 <- t(Y_2023)
X_2023 <- matrix(scale(pheno_2023$blup_light), ncol = 1)
rownames(X_2023) <- pheno_2023$parent_pop
colnames(X_2023) <- "blup_light"
common <- intersect(rownames(X_2023), rownames(Y_2023))
Y_2023 <- Y_2023[common,]
X_2023 <- X_2023[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y_2023,
X = X_2023,
K = 2)
## performs association testing using the fitted model:
pv_2023 <- lfmm_test(Y = Y_2023,
X = X_2023,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues_2023 <- pv_2023$calibrated.pvalue
plot_data_2023 = tibble(loci = geno_23[,1], p_val = pv_2023$pvalue[,1], calibrated.pvalue = pv_2023$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
light_manhattan_WL2 = plot_manhattan(plot_data_2023,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association WL2 2023",
highlight_top_n = 20)
print(light_manhattan_WL2)
# Save plot
ggsave("light_interaction_WL2_2023.png", light_manhattan_WL2, width = 12, height = 6, dpi = 300)
light_interaction_manhattan = light_manhattan_UCD / light_manhattan_WL2
top20_UCD = plot_data |>
slice_min(calibrated.pvalue, n = 20)
top20_WL2 = plot_data_2023 |>
slice_min(calibrated.pvalue, n = 20)
light_interaction_manhattan = light_manhattan_UCD / light_manhattan_WL2
top20_UCD = plot_data |>
slice_min(calibrated.pvalue, n = 20)
top20_WL2 = plot_data_2023 |>
slice_min(calibrated.pvalue, n = 20)
View(light_interaction_manhattan)
View(light_interaction_manhattan)
print(light_interaction_manhattan)
View(top20_UCD)
View(X)
View(Y)
View(Y)
View(X)
View(geno_22)
View(geno_22)
View(plot_data)
View(geno_table)
View(geno_table)
View(Y)
View(X)
View(freq_plot_data)
View(top20_WL2)
View(top20_UCD)
View(top20_UCD)
knitr::opts_chunk$set(echo = TRUE)
geno_table = Y
colnames(geno_table) = geno_23[, 1]
View(geno_23)
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(tibble)
library(dplyr)
library(tidyverse)
library(ggthemes)
library(ggrepel)
library(lfmm)
library(RSpectra)
load("pl_lt_t.lmer.RData")
load("growth_light_time.lmer.RData")
source("manhattan_plot.R")
pheno_2022 <- ranef(pl_lt_t.lmer)$pop %>%
as_tibble(rownames = "pop",.name_repair = "unique")%>%
rename(blup_intercept = `(Intercept)...1`,
blup_light = `mean_light_ly_day2`) %>%
mutate(model = "Y2022")
geno_22 <- read.delim("Data/merged_maf_common_UCD2022.tsv", header = TRUE)
Y <- as.matrix(geno_22[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2022$blup_light), ncol = 1)
rownames(X) <- pheno_2022$pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
plot_data = tibble(loci = geno_22[,1], p_val = pv$pvalue[,1], calibrated.pvalue = pv$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
manhattan_22 = plot_manhattan(plot_data,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association",
highlight_top_n = 20)
pheno_2023 <- ranef(growth_light_time.lmer)$parent_pop %>%
as_tibble(rownames = "parent_pop", .name_repair = "unique") %>%
rename(blup_intercept = `(Intercept)...1`,
blup_light = `weekly_avg_SlrW2`) %>%
mutate(model = "Y2023")
geno_23 <- read.delim("Data/merged_maf_common_WL2_2023.tsv", header = TRUE)
Y <- as.matrix(geno_23[,-1])
pc <- prcomp(Y)
plot(pc$sdev[1:20]^2, xlab = 'PC', ylab = "Variance explained")
points(2,pc$sdev[2]^2, type = "h", lwd = 3, col = "blue")
Y <- as.matrix(geno_23[,-1])
Y <- t(Y)
X <- matrix(scale(pheno_2023$blup_light), ncol = 1)
rownames(X) <- pheno_2023$parent_pop
colnames(X) <- "blup_light"
common <- intersect(rownames(X), rownames(Y))
Y <- Y[common,]
X <- X[common, , drop = FALSE]
mod.lfmm <- lfmm_ridge(Y = Y,
X = X,
K = 2)
pv <- lfmm_test(Y = Y,
X = X,
lfmm = mod.lfmm,
calibrate = "gif")
pvalues <- pv$calibrated.pvalue
#QQ plot
qqplot(rexp(length(pvalues), rate = log(10)),
-log10(pvalues), xlab = "Expected quantile",
pch = 19, cex = .4)
abline(0,1)
plot_data = tibble(loci = geno_23[,1], p_val = pv$pvalue[,1], calibrated.pvalue = pv$calibrated.pvalue[,1]) |>
separate_wider_delim(loci, delim = ":", names = c("chr", "bp")) |>
filter(str_detect(chr, "Chr")) |>
mutate(p.bonf = p.adjust(p_val, method = "bonferroni"),
bp = as.numeric(bp))
manhattan_23 = plot_manhattan(plot_data,
chr_col = "chr",
pos_col = "bp",
value_col = "calibrated.pvalue",
transform = "neglog10",
title = "Light association",
highlight_top_n = 20)
print(manhattan_23)
# Save plot
ggsave("light_interaction23.png", manhattan_23, width = 12, height = 6, dpi = 300)
library(cowplot)
plot_grid(manhattan_22, manhattan_23, ncol = 2, labels = c("2022", "2023"), rel_widths = c(1, 1))
geno_table = Y
colnames(geno_table) = geno_23[, 1]
freq_plot_data = as.data.frame(X) |>
rownames_to_column(var = "Population") |>
mutate(loci1 = as.numeric(geno_table[, "Chr2:18026903"]),
loci2 = as.numeric(geno_table[, "Chr11:6546598"]),
loci3 = as.numeric(geno_table[, "Chr13:4965604"])) |>
pivot_longer(cols = loci1:loci3, names_to = "loci", values_to = "frequency")
freq_plot_data |>
ggplot(aes(x = blup_light, y = frequency, label = Population)) +
geom_point(size = 3) +
geom_smooth(method = "lm", colour = "red") +
geom_text_repel(size = 6) +
facet_wrap(~loci, nrow = 1, scales = "free_y") +
theme_minimal()+
labs(x = "BLUP light", y = "Allele frequency")
library(cowplot)
manhattan_tot <- plot_grid(manhattan_22, manhattan_23, ncol = 2, labels = c("2022", "2023"), rel_widths = c(1, 1))
