files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 提取日期（第一列列名），重命名为 date_col
date_str <- names(df)[1]
df <- df %>% rename(date_col = !!date_str)
# 添加日期 + plant_id + 转换现有列
df <- df %>%
mutate(
date = mdy(date_str),
bed.row = as.numeric(bed.row),
height.cm = as.numeric(height.cm),
source_file = f,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_")
)
# 如果存在 long.leaf.cm 就转换
if ("long.leaf.cm" %in% names(df)) {
df <- df %>% mutate(long.leaf.cm = as.numeric(long.leaf.cm))
}
return(df)
}
)
library(tidyverse)
library(readxl)
library(lubridate)
setwd("C:/Users/Tobyz/Desktop/S.tort-light-growth/Data")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 提取日期（第一列列名），重命名为 date_col
date_str <- names(df)[1]
df <- df %>% rename(date_col = !!date_str)
# 添加日期 + plant_id + 转换现有列
df <- df %>%
mutate(
date = mdy(date_str),
bed.row = as.numeric(bed.row),
height.cm = as.numeric(height.cm),
source_file = f,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_")
)
# 如果存在 long.leaf.cm 就转换
if ("long.leaf.cm" %in% names(df)) {
df <- df %>% mutate(long.leaf.cm = as.numeric(long.leaf.cm))
}
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 提取日期（第一列列名），重命名为 date_col
date_str <- names(df)[1]
df <- df %>% rename(date_col = !!date_str)
# 添加日期 + plant_id + 转换现有列
df <- df %>%
mutate(
date = mdy(date_str),
bed.row = as.numeric(bed.row),
height.cm = as.numeric(height.cm),
source_file = f,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_")
)
# 如果存在 long.leaf.cm 就转换
if ("long.leaf.cm" %in% names(df)) {
df <- df %>% mutate(long.leaf.cm = as.numeric(long.leaf.cm))
}
return(df)
}
)
library(tidyverse)
library(readxl)
library(lubridate)
setwd("C:/Users/Tobyz/Desktop/S.tort-light-growth/Data")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 提取日期（第一列列名），重命名为 date_col
date_str <- names(df)[1]
df <- df %>% rename(date_col = !!date_str)
# 添加日期 + plant_id + 转换现有列
df <- df %>%
mutate(
date = mdy(date_str),
bed.row = as.numeric(bed.row),
height.cm = as.numeric(height.cm),
source_file = f,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_")
)
# 如果存在 long.leaf.cm 就转换
if ("long.leaf.cm" %in% names(df)) {
df <- df %>% mutate(long.leaf.cm = as.numeric(long.leaf.cm))
}
return(df)
}
)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 如果没有 bed.row，直接跳过这个文件
if (!"bed.row" %in% names(df)) {
cat("⚠️ 跳过缺列文件:", f, "\n")
return(tibble())  # 返回空 tibble
}
df <- df %>%
mutate(
date = mdy(date),
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 如果没有 bed.row，直接跳过这个文件
if (!"bed.row" %in% names(df)) {
cat("⚠️ 跳过缺列文件:", f, "\n")
return(tibble())  # 返回空 tibble
}
df <- df %>%
mutate(
date = mdy(.data$date),
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
unique(size_data$date_raw)
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 如果没有 bed.row，直接跳过这个文件
if (!"bed.row" %in% names(df)) {
cat("⚠️ 跳过缺列文件:", f, "\n")
return(tibble())  # 返回空 tibble
}
df <- df %>%
mutate(
date = mdy(.data$Date),
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(Date),  # 🔁 如果不确定首字母，改成 mdy(.data[["Date"]])
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")%>%clean_names()
library(tidyverse)
library(readxl)
library(lubridate)
library(janitor)
setwd("C:/Users/Tobyz/Desktop/S.tort-light-growth/Data")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")%>%clean_names()
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(Date),  # 🔁 如果不确定首字母，改成 mdy(.data[["Date"]])
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(date)  # 🔁 如果不确定首字母，改成 mdy(.data[["Date"]])
bed.row = as.numeric(bed.row),
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(date),  # 🔁 如果不确定首字母，改成 mdy(.data[["Date"]])
bed.row = as.numeric(bed.row),
bed.col = as.character(bed.col),
height.cm = as.numeric(height.cm),
long.leaf.cm = if ("long.leaf.cm" %in% names(.)) as.numeric(long.leaf.cm) else NA,
plant_id = paste(block, bed, bed.row, bed.col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(date),  # 首字母小写
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(long_leaf_cm) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
size_data <- map_dfr(
files,
function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE)%>%clean_names()
# 统一处理格式，确保转型安全
df <- df %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
}
)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names()
df <- df %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names()
df <- df %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
# 尝试读取每个文件
results <- map(files, safe_read_process)
# 拆出成功和失败项
successful_data <- map_dfr(results, "result")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
janitor::clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
# ✅ 成功的才合并
successful_data <- map_dfr(results, "result")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
# ✅ 成功项提取，自动带上 source_index
successful_data <- map_dfr(results, "result", .id = "source_index")
knitr::opts_chunk$set(echo = TRUE)
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
library(janitor)
library(purrr)
setwd("C:/Users/Tobyz/Desktop/S.tort-light-growth/Data")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
# ✅ 成功项提取，自动带上 source_index
successful_data <- map_dfr(results, "result", .id = "source_index")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
rm(list = ls())
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
successful_data <- map_dfr(results, "result", .id = "source_index")
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
library(janitor)
library(purrr)
setwd("C:/Users/Tobyz/Desktop/S.tort-light-growth/Data")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
successful_data <- map_dfr(results, "result", .id = "source_index")
results <- map(files, safe_read_process)
successful_results <- keep(results, ~ !is.null(.x$result))
successful_data <- bind_rows(map(successful_results, "result"), .id = "source_index")
files <- list.files(pattern = "WL2_size_survey.*\\.csv$")
safe_read_process <- safely(function(f) {
df <- read_csv(f, col_names = TRUE, show_col_types = FALSE) %>%
clean_names() %>%
mutate(
date = mdy(date),
bed_row = as.numeric(bed_row),
bed_col = as.character(bed_col),
height_cm = as.numeric(height_cm),
long_leaf_cm = if ("long_leaf_cm" %in% names(.)) as.numeric(as.character(long_leaf_cm)) else NA,
plant_id = paste(block, bed, bed_row, bed_col, sep = "_"),
source_file = f
)
return(df)
})
results <- map(files, safe_read_process)
successful_results <- keep(results, ~ !is.null(.x$result))
successful_data <- bind_rows(map(successful_results, "result"), .id = "source_index")
light_raw <- read_csv("CR1000XSeries_IntBioHalfHourTable.txt", skip = 1, show_col_types = FALSE)
# 处理
weekly_light <- light_raw %>%
mutate(
timestamp = ymd_hms(TIMESTAMP),
week = floor_date(timestamp, "week")
) %>%
group_by(week) %>%
summarise(
weekly_avg_SlrW = mean(SlrW_Avg, na.rm = TRUE),
.groups = "drop"
)
# 查看结果
print(weekly_light)
light_raw <- read_csv("CR1000XSeries_IntBioHalfHourTable.txt", skip = 1, show_col_types = FALSE)
weekly_light <- light_raw %>%
mutate(
timestamp = ymd_hms(TIMESTAMP),
SlrW_Avg = as.numeric(SlrW_Avg),  # 💡 强制转成数值型
week = floor_date(timestamp, "week")
) %>%
group_by(week) %>%
summarise(
weekly_avg_SlrW = mean(SlrW_Avg, na.rm = TRUE),
.groups = "drop"
)
# 查看结果
print(weekly_light)
